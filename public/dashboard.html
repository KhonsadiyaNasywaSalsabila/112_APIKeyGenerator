<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin</title>
    <style>
        /* Import font dari Google */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8; 
            margin: 0;
            color: #333;
            padding: 20px;
        }
        
        h1 {
            color: #006341; 
            font-weight: 700;
            font-size: 28px;
            margin-bottom: 20px;
        }

        .dashboard-wrapper {
            width: 100%;
            max-width: 1400px; /* Lebar ditambah untuk menampung kolom baru */
            margin: 20px auto;
            padding: 30px;
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .header-links {
            margin-bottom: 20px;
        }
        
        .header-links a {
            padding: 8px 15px;
            text-decoration: none;
            background-color: #006341;
            color: white;
            border-radius: 6px;
            margin-right: 10px;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        .header-links a:hover {
            background-color: #004a30;
        }

        /* Style Tabel yang ditingkatkan */
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 30px; 
        }
        th, td { 
            border: 1px solid #e0e0e0; 
            padding: 12px 15px;
            text-align: left; 
            font-size: 14px; 
        }
        th { 
            background-color: #e9f7ef; 
            color: #006341;
            font-weight: 700;
            text-transform: uppercase;
        }
        tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tbody tr:hover {
            background-color: #f0f4f8;
        }
        
        /* Style Status */
        .active { 
            color: #28a745; 
            font-weight: 600; 
        }
        .inactive { 
            color: #dc3545; 
            font-weight: 600; 
        }

        /* Style Tombol Delete */
        .delete-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: background-color 0.3s, transform 0.1s;
        }
        .delete-btn:hover {
            background-color: #c82333;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <div class="dashboard-wrapper">
        <h1>Dashboard Admin: Daftar User & API Key</h1>
        
        <div class="header-links">
            <a href="/user-register">Tambah User Baru</a>
            <a href="/logout">Logout</a>
        </div>
        
        <hr>
        
        <table id="user-table">
            <thead>
                <tr>
                    <th>ID User</th>
                    <th>Nama Depan</th> <th>Nama Belakang</th> <th>Email</th>
                    <th>API Key</th>
                    <th>Status</th>
                    <th>Dibuat</th>
                    <th>Terakhir Dipakai</th>
                    <th>Aksi</th> </tr>
            </thead>
            <tbody>
                </tbody>
        </table>
    </div>

    <script>
        // Jumlah kolom sekarang 9
        const TOTAL_COLUMNS = 9;

        // Fungsi untuk menghapus user
        async function deleteUser(userId) {
            if (!confirm(`Apakah Anda yakin ingin menghapus User ID ${userId} beserta API Key-nya? Tindakan ini tidak dapat dibatalkan.`)) {
                return;
            }

            try {
                // Menggunakan endpoint DELETE yang baru dibuat di index.js
                const response = await fetch(`/api/users/delete/${userId}`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert(`User ID ${userId} berhasil dihapus.`);
                    loadUserData(); // Muat ulang data
                } else {
                    const errorData = await response.json();
                    alert('Gagal menghapus user: ' + (errorData.message || response.statusText));
                }
            } catch (error) {
                console.error('Error delete:', error);
                alert('Terjadi kesalahan saat menghubungi server untuk menghapus user.');
            }
        }
        
        // Fungsi untuk mengambil dan menampilkan data
        async function loadUserData() {
            const tbody = document.querySelector('#user-table tbody');
            tbody.innerHTML = `<tr><td colspan="${TOTAL_COLUMNS}">Memuat data...</td></tr>`;
            
            try {
                const response = await fetch('/api/users'); 
                
                if (response.status === 401) {
                    window.location.href = '/login';
                    return;
                }
                
                const users = await response.json(); 
                
                tbody.innerHTML = ''; 
                
                if (users.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="${TOTAL_COLUMNS}">Tidak ada data User dengan API Key.</td></tr>`;
                    return;
                }

                users.forEach(user => {
                    const row = tbody.insertRow();
                    row.insertCell().textContent = user.user_id;
                    row.insertCell().textContent = user.first_name; // Nama Depan
                    row.insertCell().textContent = user.last_name;  // Nama Belakang
                    row.insertCell().textContent = user.email;
                    row.insertCell().textContent = user.api_key;
                    
                    const statusCell = row.insertCell();
                    statusCell.textContent = user.is_active ? 'Aktif' : 'Nonaktif';
                    statusCell.className = user.is_active ? 'active' : 'inactive';
                    
                    row.insertCell().textContent = new Date(user.created_at).toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                    row.insertCell().textContent = user.last_used_at 
                        ? new Date(user.last_used_at).toLocaleString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) 
                        : 'Belum pernah';
                    
                    // Kolom Aksi (Tombol Delete)
                    const actionCell = row.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'Hapus';
                    deleteBtn.className = 'delete-btn';
                    // Simpan ID User di atribut data
                    deleteBtn.setAttribute('data-user-id', user.user_id); 
                    actionCell.appendChild(deleteBtn);
                });

            } catch (error) {
                console.error('Error:', error);
                tbody.innerHTML = `<tr><td colspan="${TOTAL_COLUMNS}">Error: ${error.message}</td></tr>`;
            }
        }
        
        // Event Listener Global untuk Tombol Delete
        document.querySelector('#user-table tbody').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const userId = e.target.getAttribute('data-user-id');
                if (userId) {
                    deleteUser(userId);
                }
            }
        });

        loadUserData();
    </script>
</body>
</html>